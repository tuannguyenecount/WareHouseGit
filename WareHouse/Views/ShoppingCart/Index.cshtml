@model List<CartItem>
@{
    ViewBag.Title = "Giỏ hàng của bạn";
    Layout = "~/Views/Shared/_Layout.cshtml";
    decimal totalMoney = Model.Sum(m => m.Money);
    int totalCount = Model.Sum(m => m.Count);
}

@section Styles{
    <link rel="stylesheet" href="~/Content/popupImage.css" type="text/css" />
}

@section scripts
{
    <script src="~/Scripts/jquery.unobtrusive-ajax.min.js"></script>
    <script>
        document.querySelector("input[type=number]").addEventListener("keypress", function (evt) {
            if (evt.which < 48 || evt.which > 57) {
                evt.preventDefault();
            }
        });
    </script>
    <script>
        $(function () {
            // Event khi người dùng click vào hình ảnh có class popupImage
            $(".popupImage").click(function () {
                var modal = document.getElementById("modalShowImage");  // Tạo biến modal lấy ra element có Id  modalShowImage
                var captionText = document.getElementById("caption");  // Tạo biến captionText lấy ra từ element có Id caption
                var modalImg = document.getElementById("img01");   // Tạo biến modalImg lấy ra từ element có Id img01
                modal.style.display = "block";    // Hiển thị  popup
                modalImg.src = $(this).attr("src");  // Gán thuộc tính src của hình ảnh trong popup
                captionText.innerHTML = $(this).attr("alt");   // Gán giá trị cho caption theo thuộc tính alt của hình
            });
            // Event khi người dùng click nút Close popup
            $(".modal-Image .close").click(function () {
                var modal = document.getElementById("modalShowImage");
                modal.style.display = 'none';  // Ẩn popup
            });
        });
    </script>
}


<!-- The Modal -->
<div id="modalShowImage" class="modal-Image">
    <!-- The Close Button -->
    <span class="close">&times;</span>
    <!-- Modal Content (The Image) -->
    <img class="modal-content" id="img01">
    <!-- Modal Caption (Image Text) -->
    <div id="caption"></div>
</div>


<div class="content-section">
    <div class="container">
        <div class="row">
            @if (Model != null && Model.Count > 0)
            {
                int i = 1;
                <div class="col-md-9">
                    <div class="divTitle2">
                        <span class="glyphicon glyphicon-shopping-cart"></span> Giỏ hàng
                    </div> <!-- /.section -->
                    <div class="table-responsive">
                        <table class="table table-hover table-bordered table-middle">
                            <tr>
                                <th class="text-center col-md-2"></th>
                                <th class="text-center col-md-1">Mã</th>
                                <th class="text-center col-md-4">Tên sản phẩm</th>
                                <th class="text-center col-md-2">Thông tin thêm</th>
                                <th class="text-center col-md-2">Đơn giá</th>
                                <th class="text-center col-md-1">Số lượng</th>
                                <th class="text-center col-md-2">Thành tiền</th>
                                <th></th>
                                <th></th>
                            </tr>
                            @foreach (CartItem item in Model)
                            {
                                    <tr>
                                        <td class="text-center"><img src="@item.ImageCustom" alt="@item.Name" width="100" title="@item.Name" class="popupImage" height="auto" /> </td>
                                        <td class="text-center">@item.Id <input type="hidden" name="id" value="@item.Id" /> </td>
                                        <td><a target="_blank" href="@Url.Action("Details","Product", new {alias = item.Alias})">@item.Name</a></td>
                                        <td><b>@item.Property</b></td>
                                        <td class="text-center">@item.Price.ToString("#,##0") đồng</td>
                                        <td class="text-center"><input type="number" value="@item.Count" onkeyup="document.getElementById('CountMoiId@(i)').value=this.value" onchange="document.getElementById('CountMoiId@(i)').value=this.value" step="1"  style="width:50px"  min="1" /></td>
                                        <td class="text-center">@item.Money.ToString("#,##0").Replace(',', '.') đồng</td>
                                        <td class="text-center">
                                            <form action="@Url.Action("Delete")" method="post">
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <input type="hidden" name="property" value="@item.Property" />
                                                <button type="submit" onclick="return confirm('Bạn muốn xóa sản phẩm @(item.Name) khỏi giỏ hàng?');" class="btn btn-danger btn-sm">
                                                    <span class="glyphicon glyphicon-remove"></span> Xóa
                                                </button>
                                            </form>
                                        </td>
                                        <td class="text-center">
                                            @using (Html.BeginForm("Edit", "ShoppingCart", FormMethod.Post)) {
                                                <input type="hidden" value="@item.Count" step="1" style="width:50px" name="Countmoi" id="CountMoiId@(i++)" min="1" />
                                                <input type="hidden" name="id" value="@item.Id" />
                                                <input type="hidden" name="property" value="@item.Property" />
                                                <button type="submit" class="btn btn-default btn-sm btnCapNhat"><span class="glyphicon glyphicon-edit"></span> Cập nhật</button>
                                            }
                                        </td>
                                    </tr>
                            }
                        </table>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="divTitle2">
                        <span class="glyphicon glyphicon-pencil"></span> Thống kê giỏ hàng
                    </div> <!-- /.section -->
                    <div class="bgGray text-center" style="overflow:hidden;">
                        <h5>Tổng số lượng: <span id="TotalCount">@totalCount</span> sản phẩm</h5>
                        <h5>Tổng thành tiền: <span id="TotalMoney">@totalMoney.ToString("#,##0").Replace(',', '.')</span> đồng</h5>
                    </div>
                    <div class="text-center">
                        <br />
                        @if (User.Identity.IsAuthenticated == false) {

                            <!-- <a href="@Url.Action("Login","Account")" class="btn btn-primary">Đăng nhập để đặt hàng</a> -->
                            <button type="button" data-toggle="modal" class="btnMuaNgay" data-target="#modalDatHang">Đặt Hàng</button>
                        }
                        else {
                            <form action="@Url.Action("ThemOrder","Order")" method="post" style="display:inline-block">
                                <div class="form-group">
                                    <label>Thanh toán trực tuyến</label><br />
                                    <input type="checkbox" name="thanhtoantructuyen" value="true" /> Đồng ý
                                </div>
                                @Html.AntiForgeryToken()
                                <button class="btnMuaNgay" type="submit" onclick="return confirm('Đồng ý đặt hàng?')">
                                    <span class="glyphicon glyphicon-earphone"></span> Đặt Hàng Ngay
                                </button>
                            </form>
                        }
                    </div>
                </div>
                <!-- Modal -->
                <div class="modal fade" id="modalDatHang" role="dialog">
                    <div class="modal-dialog">
                        <!-- Modal content-->
                        <div class="modal-content">
                            <div class="modal-header divTitle2">
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                                <span class="modal-title">ĐẶT HÀNG ONLINE</span>
                            </div>
                            <div class="modal-body col-md-12" style="padding:30px 30px;">
                                <span>Nhập các thông tin của bạn bên dưới để thực hiện đặt hàng. Chúng tôi sẽ liên hệ với bạn qua Email hoặc SĐT của bạn trong thời gian sớm nhất để xác thực việc mua hàng.</span>
                                <div>&nbsp;</div>
                                <form class="form-horizontal" role="form" method="post" action="@Url.Action("ThemOrder","Order")">
                                    @Html.AntiForgeryToken()
                                    <div class="form-group">
                                        <label class="control-label col-sm-4">Thanh toán trực tuyến</label>
                                        <div class="col-md-8">
                                            <input type="checkbox" name="thanhtoantructuyen" value="true" /> Đồng ý
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-sm-4" for="Name">Họ tên:</label>
                                        <div class="col-sm-8">
                                            <input style="width:90%" type="text" class="form-control" id="Name" name="Name">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-sm-4" for="email">Email:</label>
                                        <div class="col-sm-8">
                                            <input style="width:90%" type="email" class="form-control" name="Email" id="email">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-sm-4" for="Phone">Số điện thoại:</label>
                                        <div class="col-sm-8">
                                            <input style="width:90%" type="text" class="form-control" id="Phone" name="Phone">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label col-sm-4" for="Address">Địa chỉ:</label>
                                        <div class="col-sm-8">
                                            <input style="width:90%" type="text" class="form-control" id="Address" name="Address">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="col-sm-12 text-center">
                                            <button id="btnOrder" type="submit" class="btnMuaNgay"> <span class="glyphicon glyphicon-earphone"></span> Đặt hàng</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-edit"></span> Chỉnh sửa giỏ hàng</button>
                            </div>
                        </div>

                    </div>
                </div>
            }
            else
            {
                <div class="col-md-12 text-center">
                    <div>
                        <img src="~/images/empty_cart.png" class="emptyCart" />
                    </div>
                    <h3>Giỏ hàng của bạn rỗng</h3>
                </div>
            }
        </div> <!-- /.row -->

        <div class="row">

        </div> <!-- /.row -->
    </div> <!-- /.container -->
</div> <!-- /.content-section -->